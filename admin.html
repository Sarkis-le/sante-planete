<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Administration – Santé Planète</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-page: #020617;
      --bg-card: rgba(15, 23, 42, 0.78);
      --bg-card-soft: rgba(15, 23, 42, 0.7);
      --accent: #38bdf8;          /* Bleu cyan */
      --accent-2: #a855f7;        /* Violet */
      --accent-soft: rgba(56, 189, 248, 0.15);
      --border-subtle: rgba(148, 163, 184, 0.3);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --shadow-strong: 0 24px 60px rgba(15, 23, 42, 0.85);
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
      --glass-blur: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background:
        radial-gradient(circle at top left, #1d2448 0, #020617 55%),
        radial-gradient(circle at bottom right, #020617 0, #020617 55%);
      color: var(--text-main);
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .header {
      padding: 16px 0 24px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      margin-bottom: 24px;
    }

    .title {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin-top: 4px;
      color: var(--text-muted);
      max-width: 640px;
      font-size: 0.9rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at top left,
        rgba(56, 189, 248, 0.2),
        rgba(15, 23, 42, 0.9)
      );
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: var(--accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 10px;
      backdrop-filter: blur(var(--glass-blur));
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle, #f9fafb 0, var(--accent) 60%);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.9);
    }

    .card-grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 1.5fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .card-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background:
        radial-gradient(circle at top right, rgba(56, 189, 248, 0.08), transparent 55%),
        radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.08), transparent 55%),
        var(--bg-card);
      border-radius: 20px;
      padding: 18px 18px 20px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(var(--glass-blur));
    }

    .card h2 {
      font-size: 1.05rem;
      margin: 0 0 8px;
    }

    .card p.desc {
      margin: 0 0 12px;
      color: var(--text-muted);
      font-size: 0.86rem;
    }

    .top-link {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .table-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .table-toolbar-title {
      font-weight: 600;
      font-size: 0.98rem;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 0.86rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #020617;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        transform 0.08s ease,
        box-shadow 0.14s ease,
        filter 0.12s ease;
      box-shadow: 0 14px 30px rgba(56, 189, 248, 0.4);
      white-space: nowrap;
    }

    .btn-primary span.icon {
      font-size: 1rem;
    }

    .btn-primary:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(168, 85, 247, 0.45);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.8);
    }

    .article-list {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.88)
      );
      max-height: 430px;
      overflow: auto;
      backdrop-filter: blur(calc(var(--glass-blur) - 4px));
    }

    .empty {
      padding: 16px;
      font-size: 0.86rem;
      color: var(--text-muted);
      text-align: center;
    }

    .article-header-row {
      display: grid;
      grid-template-columns: 60px minmax(0, 2.3fr) minmax(0, 1.6fr) 130px;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.95);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      background: radial-gradient(circle at top left,
        rgba(56, 189, 248, 0.15),
        rgba(15, 23, 42, 0.95)
      );
      position: sticky;
      top: 0;
      z-index: 1;
    }

    @media (max-width: 800px) {
      .article-header-row {
        display: none;
      }
    }

    .article-item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      font-size: 0.86rem;
      display: grid;
      grid-template-columns: 60px minmax(0, 2.3fr) minmax(0, 1.6fr) 130px;
      gap: 10px;
      align-items: center;
      transition: background 0.14s ease, transform 0.06s ease;
    }

    .article-item:last-child {
      border-bottom: none;
    }

    .article-item:hover {
      background: radial-gradient(circle at top left,
        rgba(56, 189, 248, 0.08),
        transparent 65%
      );
      transform: translateY(-1px);
    }

    @media (max-width: 800px) {
      .article-item {
        grid-template-columns: 60px minmax(0, 1fr);
        grid-template-rows: auto auto auto;
      }
    }

    .thumb-mini {
      width: 100%;
      height: 46px;
      border-radius: 10px;
      object-fit: cover;
      background: radial-gradient(circle at center, #1f2937, #020617);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .thumb-mini.placeholder {
      border: 1px dashed rgba(148, 163, 184, 0.6);
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .article-item-title {
      font-weight: 600;
      line-height: 1.3;
    }

    .article-item-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 9px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.75rem;
      color: var(--text-muted);
      gap: 3px;
    }

    .chip strong {
      color: var(--accent);
      margin-right: 2px;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .btn-sm {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 0.75rem;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s ease, border-color 0.12s ease,
        transform 0.06s ease;
    }

    .btn-sm.edit {
      border-color: rgba(56, 189, 248, 0.7);
      color: #e0f2fe;
    }

    .btn-sm.delete {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .btn-sm:hover {
      background: rgba(15, 23, 42, 0.98);
      transform: translateY(-0.5px);
    }

    .count-label {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .info-list {
      margin-top: 8px;
      padding-left: 16px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .info-list li + li {
      margin-top: 4px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(2, 6, 23, 0.96));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(22px);
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 620px;
      background:
        radial-gradient(circle at top right, rgba(56, 189, 248, 0.12), transparent 60%),
        radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.10), transparent 60%),
        rgba(15, 23, 42, 0.96);
      border-radius: 22px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-strong);
      padding: 18px 18px 20px;
      position: relative;
      backdrop-filter: blur(var(--glass-blur));
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.4rem;
      cursor: pointer;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 999px;
      transition: background 0.12s ease, color 0.12s ease;
    }

    .modal-close:hover {
      background: rgba(15, 23, 42, 0.95);
      color: #f9fafb;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    label {
      font-size: 0.88rem;
      color: var(--text-muted);
      margin-bottom: 2px;
      display: block;
    }

    input[type="text"],
    textarea,
    select,
    input[type="file"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding: 8px 10px;
      font-size: 0.94rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease, transform 0.08s ease;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus,
    input[type="file"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: #020617;
      transform: translateY(-0.5px);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
    }

    @media (max-width: 640px) {
      .row {
        flex-direction: column;
      }
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .modal-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-muted);
      font-size: 0.78rem;
      padding: 6px 14px;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.7);
    }

    #message {
      font-size: 0.85rem;
      min-height: 1.1em;
      margin-top: 4px;
    }

    #message.ok {
      color: #4ade80;
    }

    #message.err {
      color: #fca5a5;
    }

    /* ---------- ÉDITEUR RICHE ---------- */

    .editor-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 4px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.9)
      );
    }

    .editor-btn {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 0.78rem;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s ease, border-color 0.12s ease,
        transform 0.06s ease;
    }

    .editor-btn:hover {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(56, 189, 248, 0.6);
      transform: translateY(-0.5px);
    }

    .editor-btn[data-block] {
      font-weight: 600;
    }

    .editor-divider {
      width: 1px;
      align-self: stretch;
      background: rgba(55, 65, 81, 0.9);
      margin: 0 2px;
    }

    .rich-editor {
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 11px;
      min-height: 180px;
      max-height: 420px;
      overflow-y: auto;
      font-size: 0.94rem;
      line-height: 1.6;
      outline: none;
    }

    .rich-editor:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: #020617;
    }

    .rich-editor.empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
      pointer-events: none;
      display: block;
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="header">
      <div class="badge">
        <span class="badge-dot"></span>
        Santé Planète — Administration
      </div>
      <div class="title">Administration – Santé Planète</div>
      <p class="subtitle">
        Gérez ici les articles de conseils santé et d’actualités publiés sur Santé Planète.
      </p>
      <div class="top-link">
        ← <a href="/">Retour au site public</a>
      </div>
    </header>

    <main class="card-grid">
      <!-- Colonne gauche : liste des articles -->
      <section class="card">
        <div class="table-toolbar">
          <div class="table-toolbar-title">
            Articles publiés
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span id="articles-count" class="count-label"></span>
            <button type="button" class="btn-primary" id="openCreateBtn">
              <span class="icon">＋</span> Nouvel article
            </button>
          </div>
        </div>
        <p class="desc">
          Retrouvez ici tous les articles enregistrés dans la base, avec la possibilité
          de les modifier ou de les supprimer.
        </p>

        <div class="article-list" id="articles-list">
          <div class="empty">Chargement des articles…</div>
        </div>
      </section>

      <!-- Colonne droite : infos -->
      <section class="card">
        <h2>Infos pratiques</h2>
        <p class="desc">
          Les modifications sont immédiatement prises en compte sur le site public
          dès que l’enregistrement a réussi.
        </p>
        <ul class="info-list">
          <li><strong>Slug</strong> : utilisé pour l’URL de l’article, évitez les espaces.</li>
          <li><strong>Catégorie</strong> : choisie dans la liste (Santé, Nutrition, etc.).</li>
          <li><strong>Image</strong> : vous pouvez choisir une image depuis votre ordinateur ; elle sera stockée dans la base.</li>
          <li>Vous pouvez revenir modifier un article ultérieurement sans le recréer.</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Modal création / édition -->
  <div class="modal-backdrop" id="articleModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Nouvel article</div>
        <button type="button" class="modal-close" id="modalCloseBtn" aria-label="Fermer">
          ×
        </button>
      </div>
      <p class="desc" id="modalSubtitle">
        Renseignez le titre, le slug (URL), la catégorie, une image illustrative,
        un éventuel résumé et le contenu détaillé de l’article.
      </p>

      <form id="article-form" autocomplete="off">
        <div class="form-grid">
          <div>
            <label for="title">Titre de l’article *</label>
            <input id="title" name="title" type="text" required />
          </div>

          <div class="row">
            <div>
              <label for="slug">Slug (URL) *</label>
              <input
                id="slug"
                name="slug"
                type="text"
                placeholder="ex : sommeil-reparateur"
                required
              />
              <div class="hint">
                Utilisez uniquement des lettres, chiffres et tirets
                <code>-</code>.
              </div>
            </div>
            <div>
              <label for="category">Catégorie</label>
              <select id="category" name="category">
                <option value="">— Choisir une catégorie —</option>
                <option value="Santé">Santé</option>
                <option value="Nutrition">Nutrition</option>
                <option value="Psychologie">Psychologie</option>
                <option value="Bien-être">Bien-être</option>
                <option value="Vie quotidienne">Vie quotidienne</option>
              </select>
              <div class="hint">
                Choisissez une catégorie parmi la liste proposée.
              </div>
            </div>
          </div>

          <div>
            <label for="imageFile">Image de l’article (depuis votre ordinateur)</label>
            <input
              id="imageFile"
              name="imageFile"
              type="file"
              accept="image/*"
            />
            <div class="hint" id="currentImageHint">
              Aucune image sélectionnée pour le moment.
            </div>
          </div>

          <div>
            <label for="summary">Résumé (facultatif)</label>
            <textarea
              id="summary"
              name="summary"
              rows="2"
              placeholder="Petite introduction à l’article…"
            ></textarea>
          </div>

          <!-- NOUVEL ÉDITEUR RICHE -->
          <div class="editor-wrapper">
            <label for="contentEditor">Contenu de l’article *</label>

            <div class="editor-toolbar" aria-label="Barre d’édition du contenu">
              <button type="button" class="editor-btn" data-cmd="bold"><strong>B</strong></button>
              <button type="button" class="editor-btn" data-cmd="italic"><em>I</em></button>
              <button type="button" class="editor-btn" data-cmd="underline"><span style="text-decoration:underline;">U</span></button>

              <div class="editor-divider"></div>

              <button type="button" class="editor-btn" data-block="p" data-cmd="formatBlock" data-value="p">Parag.</button>
              <button type="button" class="editor-btn" data-block="h2" data-cmd="formatBlock" data-value="h2">H2</button>
              <button type="button" class="editor-btn" data-block="h3" data-cmd="formatBlock" data-value="h3">H3</button>

              <div class="editor-divider"></div>

              <button type="button" class="editor-btn" data-cmd="insertUnorderedList">• Liste</button>
              <button type="button" class="editor-btn" data-cmd="insertOrderedList">1. Liste</button>

              <div class="editor-divider"></div>

              <button type="button" class="editor-btn" data-cmd="createLink" data-link="true">Lien</button>
              <button type="button" class="editor-btn" data-cmd="removeFormat">Effacer style</button>
            </div>

            <div
              id="contentEditor"
              class="rich-editor empty"
              contenteditable="true"
              data-placeholder="Rédigez ici le contenu complet de l’article (vous pouvez mettre du gras, des titres, des listes, des liens…)."
            ></div>

            <!-- Champ caché pour envoyer le HTML au serveur -->
            <input type="hidden" id="contentInput" name="content" />
            <div class="hint">
              Vous pouvez sélectionner le texte et utiliser la barre d’outils comme dans un traitement de texte.
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelBtn">Annuler</button>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            <button type="submit" class="btn-primary" id="submit-btn">
              Enregistrer l’article
            </button>
            <span class="hint">Les champs marqués d’une * sont obligatoires.</span>
          </div>
        </div>

        <div id="message" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const listContainer   = document.getElementById("articles-list");
    const countLabel      = document.getElementById("articles-count");
    const openCreateBtn   = document.getElementById("openCreateBtn");
    const modalBackdrop   = document.getElementById("articleModal");
    const modalCloseBtn   = document.getElementById("modalCloseBtn");
    const cancelBtn       = document.getElementById("cancelBtn");
    const modalTitle      = document.getElementById("modalTitle");
    const articleForm     = document.getElementById("article-form");
    const submitBtn       = document.getElementById("submit-btn");
    const message         = document.getElementById("message");
    const imageFileInput  = document.getElementById("imageFile");
    const currentImageHint = document.getElementById("currentImageHint");

    const contentEditor   = document.getElementById("contentEditor");
    const contentInput    = document.getElementById("contentInput");
    const toolbarButtons  = document.querySelectorAll(".editor-btn");

    let ARTICLES = [];
    let currentMode = "create"; // "create" | "edit"
    let currentId = null;
    let currentImageUrl = "";   // stocke l'image actuelle (URL ou dataURL) en mode édition

    // ----------- RICH TEXT : gestion du placeholder -----------
    function refreshEditorPlaceholder() {
      const txt = contentEditor.textContent.replace(/\u200B/g, "").trim();
      if (!txt && !contentEditor.innerHTML.match(/<img|<br|<p|<h[1-6]|<ul|<ol/i)) {
        contentEditor.classList.add("empty");
      } else {
        contentEditor.classList.remove("empty");
      }
    }

    contentEditor.addEventListener("input", refreshEditorPlaceholder);
    contentEditor.addEventListener("blur", refreshEditorPlaceholder);
    contentEditor.addEventListener("focus", () => {
      contentEditor.classList.remove("empty");
    });

    // ----------- RICH TEXT : gestion de la toolbar -----------
    toolbarButtons.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const cmd = btn.dataset.cmd;
        const value = btn.dataset.value || null;

        // Commande spéciale pour les liens
        if (btn.dataset.link === "true") {
          const url = prompt("Adresse du lien (URL) :", "https://");
          if (!url) {
            return;
          }
          document.execCommand("createLink", false, url);
        } else if (cmd === "formatBlock") {
          document.execCommand("formatBlock", false, value || "p");
        } else {
          document.execCommand(cmd, false, value);
        }

        contentEditor.focus();
        refreshEditorPlaceholder();
      });
    });

    // ----------- MODAL -----------
    function openModal(mode = "create", article = null) {
      currentMode = mode;
      currentId = article && article.id != null ? article.id : null;

      if (mode === "create") {
        modalTitle.textContent = "Nouvel article";
        submitBtn.textContent  = "Publier l’article";
        articleForm.reset();
        currentImageUrl = "";
        currentImageHint.textContent = "Aucune image sélectionnée pour le moment.";
        contentEditor.innerHTML = "";
        refreshEditorPlaceholder();
      } else {
        modalTitle.textContent = "Modifier l’article";
        submitBtn.textContent  = "Enregistrer les modifications";

        articleForm.title.value    = article.title    || "";
        articleForm.slug.value     = article.slug     || "";
        articleForm.summary.value  = article.summary  || "";

        const catSelect  = articleForm.category;
        const currentCat = article.category || "";

        if (
          currentCat &&
          ![...catSelect.options].some(opt => opt.value === currentCat)
        ) {
          const opt = document.createElement("option");
          opt.value = currentCat;
          opt.textContent = currentCat;
          catSelect.appendChild(opt);
        }
        catSelect.value = currentCat;

        currentImageUrl = article.imageUrl || "";
        if (currentImageUrl) {
          currentImageHint.textContent = "Une image est déjà associée à cet article. Vous pouvez en choisir une nouvelle pour la remplacer.";
        } else {
          currentImageHint.textContent = "Aucune image enregistrée pour cet article. Vous pouvez en sélectionner une.";
        }

        imageFileInput.value = "";

        // contenu HTML
        const htmlContent = article.content || "";
        contentEditor.innerHTML = htmlContent;
        contentInput.value = htmlContent;
        refreshEditorPlaceholder();
      }

      message.textContent = "";
      message.className   = "";

      modalBackdrop.classList.add("active");
      modalBackdrop.setAttribute("aria-hidden", "false");
      setTimeout(() => {
        articleForm.title.focus();
      }, 10);
    }

    function closeModal() {
      modalBackdrop.classList.remove("active");
      modalBackdrop.setAttribute("aria-hidden", "true");
      currentId = null;
      currentMode = "create";
      currentImageUrl = "";
    }

    openCreateBtn.addEventListener("click", () => openModal("create"));
    modalCloseBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modalBackdrop.classList.contains("active")) {
        closeModal();
      }
    });

    // ----------- CHARGEMENT / AFFICHAGE DES ARTICLES -----------
    async function loadArticles() {
      try {
        const res = await fetch("/api/articles");
        if (!res.ok) throw new Error("Erreur HTTP");
        const articles = await res.json();
        ARTICLES = Array.isArray(articles) ? articles : [];

        renderArticles();
      } catch (err) {
        console.error(err);
        listContainer.innerHTML =
          '<div class="empty">Erreur lors du chargement des articles.</div>';
        countLabel.textContent = "";
      }
    }

    function renderArticles() {
      if (!ARTICLES.length) {
        listContainer.innerHTML =
          '<div class="empty">Aucun article pour le moment.</div>';
        countLabel.textContent = "";
        return;
      }

      countLabel.textContent =
        ARTICLES.length + (ARTICLES.length > 1 ? " articles" : " article");

      listContainer.innerHTML = "";

      const header = document.createElement("div");
      header.className = "article-header-row";
      header.innerHTML = `
        <div>Image</div>
        <div>Titre</div>
        <div>Slug / Catégorie</div>
        <div style="text-align:right;">Actions</div>
      `;
      listContainer.appendChild(header);

      for (const art of ARTICLES) {
        const div = document.createElement("div");
        div.className = "article-item";

        // Image
        let thumb;
        if (art.imageUrl) {
          thumb = document.createElement("img");
          thumb.className = "thumb-mini";
          thumb.src = art.imageUrl;
          thumb.alt = art.title || "Illustration";
          thumb.loading = "lazy";
        } else {
          thumb = document.createElement("div");
          thumb.className = "thumb-mini placeholder";
          thumb.textContent = "Aucune image";
        }
        div.appendChild(thumb);

        // Titre
        const title = document.createElement("div");
        title.className = "article-item-title";
        title.textContent = art.title || "(sans titre)";
        div.appendChild(title);

        // Slug + catégorie
        const meta = document.createElement("div");
        meta.className = "article-item-meta";

        const slugChip = document.createElement("span");
        slugChip.className = "chip";
        slugChip.innerHTML =
          "<strong>Slug</strong>" + (art.slug || "—");

        const catChip = document.createElement("span");
        catChip.className = "chip";
        catChip.innerHTML =
          "<strong>Cat.</strong>" + (art.category || "non définie");

        meta.appendChild(slugChip);
        meta.appendChild(catChip);
        div.appendChild(meta);

        // Actions
        const actions = document.createElement("div");
        actions.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-sm edit";
        editBtn.textContent = "Modifier";
        editBtn.addEventListener("click", () => {
          if (art.id == null) {
            Swal.fire("Erreur", "Impossible de modifier : aucun identifiant (id) renvoyé par l’API.", "error");
            return;
          }
          openModal("edit", art);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "btn-sm delete";
        deleteBtn.textContent = "Supprimer";
        deleteBtn.addEventListener("click", async () => {
          if (art.id == null) {
            Swal.fire("Erreur", "Impossible de supprimer : aucun identifiant (id) renvoyé par l’API.", "error");
            return;
          }

          Swal.fire({
            title: "Supprimer cet article ?",
            text: "Cette action est définitive.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Oui, supprimer",
            cancelButtonText: "Annuler"
          }).then(async (result) => {
            if (!result.isConfirmed) return;

            try {
              const res = await fetch("/api/articles?id=" + encodeURIComponent(art.id), {
                method: "DELETE",
              });
              if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.error || "Erreur serveur");
              }
              ARTICLES = ARTICLES.filter(a => a.id !== art.id);
              renderArticles();
              Swal.fire("Supprimé", "L’article a été supprimé.", "success");
            } catch (err) {
              console.error(err);
              Swal.fire("Erreur", "Impossible de supprimer l’article.", "error");
            }
          });
        });

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        div.appendChild(actions);

        listContainer.appendChild(div);
      }
    }

    // ----------- UTIL : fichier -> dataURL -----------
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    // ----------- SUBMIT FORM -----------
    articleForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      message.textContent = "";
      message.className = "";
      submitBtn.disabled = true;

      const title   = articleForm.title.value.trim();
      const slug    = articleForm.slug.value.trim();
      const summary = articleForm.summary.value.trim();
      const category = articleForm.category.value;

      // On récupère le HTML + le texte brut de l’éditeur
      const htmlContent = contentEditor.innerHTML.trim();
      const textContent = contentEditor.textContent.replace(/\u200B/g, "").trim();

      if (!title || !slug || !textContent) {
        message.textContent =
          "Merci de remplir au minimum le titre, le slug et le contenu.";
        message.classList.add("err");
        submitBtn.disabled = false;
        return;
      }

      contentInput.value = htmlContent;

      let imageUrlToSave = currentImageUrl;

      // Si un fichier est sélectionné, on le convertit en Data URL
      const file = imageFileInput.files && imageFileInput.files[0];
      if (file) {
        try {
          imageUrlToSave = await fileToDataUrl(file);
        } catch (err) {
          console.error("Erreur lecture fichier image", err);
          Swal.fire("Erreur", "Impossible de lire l’image sélectionnée.", "error");
          submitBtn.disabled = false;
          return;
        }
      }

      const payload = {
        title,
        slug,
        summary,
        category,
        imageUrl: imageUrlToSave,
        content: htmlContent,
      };

      try {
        let url = "/api/articles";
        let method = "POST";

        if (currentMode === "edit" && currentId != null) {
          url = "/api/articles?id=" + encodeURIComponent(currentId);
          method = "PUT";
        }

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "Erreur serveur");
        }

        message.textContent =
          currentMode === "create"
            ? "Article enregistré avec succès."
            : "Article modifié avec succès.";
        message.classList.add("ok");

        await loadArticles();

        await Swal.fire(
          "Succès",
          currentMode === "create"
            ? "L’article a été créé avec succès."
            : "L’article a été mis à jour avec succès.",
          "success"
        );

        closeModal();
      } catch (err) {
        console.error(err);
        message.textContent =
          "Impossible d’enregistrer l’article. Vérifiez votre connexion ou réessayez plus tard.";
        message.classList.add("err");
        Swal.fire(
          "Erreur",
          "Impossible d’enregistrer l’article. Vérifiez votre connexion ou réessayez plus tard.",
          "error"
        );
      } finally {
        submitBtn.disabled = false;
      }
    });

    loadArticles();
  </script>
</body>
</html>
